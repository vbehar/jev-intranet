<%
  translated_state = {'new' => 'Nouvelle', 'paid' => 'Payée', 'upstream' => 'Saisie FFCK', 'sent' => 'Envoyée'}
  @title = 'Mes cotisations'
  @breadcrumb = [['/', 'Accueil'], ['/subscriptions', @title]]
%>

<div id="contentfull">

<h2><%= @title %></h2>

<% if @subscription %>
  <form method="post">
    <div class="tinyform">
      <h3>Nouvelle cotisation pour la saison <%= @subscription.year %></h3>
      <p><a href="/account">Merci de valider vos coordonnées avant de valider !</a><br />Renseignez les informations concernant votre certificat médical (type et date), et déposez-en une copie au club.<br />La cotisation ne sera acceptée que lorsque le paiement aura été effectué et reçu par le trésorier.</p>

      <label for="subscription_price">Prix<span class="labeltip">En euros</span></label>
      <input type="text" name="subscription[price]" id="subscription_price" value="<%= @subscription.price %>" readonly="readonly" />

      <label for="subscription_medical_certificate_type">Certificat médical<span class="labeltip">Type</span></label>
      <select name="subscription[medical_certificate_type]" id="subscription_medical_certificate_type" class="<%= 'error' if @subscription.errors.on :medical_certificate_type %>">
        <% [nil, 'Compétition', 'Loisirs'].each do |type| %>
          <option value="<%= type %>" <%= "selected='selected'" if @subscription.medical_certificate_type == type %>><%= type %></option>
        <% end %>
      </select>

      <label for="subscription_medical_certificate_date">Certificat médical<span class="labeltip">Date (jj/mm/aaaa)</span></label>
      <input type="text" name="subscription[medical_certificate_date]" id="subscription_medical_certificate_date" class="input_date <%= 'error' if @subscription.errors.on :medical_certificate_date %>" value="<%= @subscription.medical_certificate_date %>" />

      <label for="subscription_comment">Commentaires<span class="labeltip">Facultatif</span></label>
      <textarea name="subscription[comment]" id="subscription_comment" rows="3" cols="30"><%= @subscription.comment %></textarea>

      <button type="submit">Valider la cotisation</button>
      <div class="spacer"></div>
    </div>
  </form>
  <p class="clear"></p>
<% end %>

<% @subscriptions.each do |s| %>
  <h3><%= s.year %></h3>

  <dl>
    <dt>Etat</dt>
    <dd><strong><%= translated_state[s.state] %></strong></dd>
  </dl>

  <% unless s.comment.blank? %>
    <dl>
      <dt>Commentaire</dt>
      <dd><%= s.comment %></dd>
    </dl>
  <% end %>

  <dl>
    <dt>Certificat médical</dt>
    <dd><%= s.medical_certificate_type %> - <%= s.medical_certificate_date.strftime '%d/%m/%Y' rescue nil %></dd>
  </dl>

  <dl>
    <dt>Prix (théorique)</dt>
    <dd><%= s.price %> euros</dd>
  </dl>

  <% unless s.payment.nil? %>
    <% p = s.payment %>
    <dl>
      <dt>Paiement</dt>
      <dd><%= "#{p.amount.to_i} euros en #{p.type} le #{p.date.strftime('%A %d %B %Y')}" %><%= " (#{p.comment})" unless p.comment.blank? %></dd>
    </dl>
  <% end %>

  <dl>
    <dt>Date de création</dt>
    <dd><%= s.created_at.strftime 'Le %A %d %B %Y à %Hh%M' %></dd>
  </dl>

  <dl>
    <dt>Dernière modification</dt>
    <dd><%= s.updated_at.strftime 'Le %A %d %B %Y à %Hh%M' %></dd>
  </dl>

  <p class="clear"></p>
<% end %>

<hr class="clear" />
</div>

<script type="text/javascript">
  //<![CDATA[
  $(document).ready(function(){
    $(".input_date").datepicker({
      dateFormat:'dd/mm/yy',
      changeMonth:true, changeYear:true, yearRange:'<%= Date.today.year - 1 %>:<%= Date.today.year + 1 %>',
      showButtonPanel:true, closeText:'X', showOn:'both',
      buttonImage:'/images/icons/calendar.gif', buttonImageOnly:true,
      buttonText:'Calendrier', currentText:'Aujourd\'hui'
    });
  });
  //]]>
</script>

